% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit.R
\name{fit_retro}
\alias{fit_retro}
\title{Retrospective fits for TAM}
\usage{
fit_retro(fit, folds = 2, grad_tol = 0.001, progress = TRUE, globals = NULL)
}
\arguments{
\item{fit}{A fitted TAM object as returned by \code{\link[=fit_tam]{fit_tam()}}.}

\item{folds}{Integer; number of terminal peels (default \code{2}).}

\item{grad_tol}{Numeric tolerance for \verb{max|grad|}. Default \code{1e-3}. Output
from retro fits that exceed this tolerance are dropped (see
\code{\link[=check_convergence]{check_convergence()}}).}

\item{progress}{Logical; show progress bar using \code{\link[progressr:with_progress]{progressr::with_progress()}}.}

\item{globals}{Character vector naming global objects to supply to the workers.}
}
\value{
A list whose elements are:
\itemize{
\item \code{obs_pred} — a named list of stacked data frames (e.g., \code{catch}, \code{index});
\item \code{pop} — a named list of stacked data frames (e.g., \code{ssb}, \code{N}, \code{M},
\code{mu_M}, \code{F}, \code{mu_F}, \code{Z}, \code{ssb_mat}); and,
\item \code{retro_fits} - refitted objects for each peel (named by terminal year).
The \code{obs_pred} and \code{pop} objects are created using \code{\link[=tidy_tam]{tidy_tam()}}.
}
}
\description{
Creates a sequence of terminal-year peels and refits the model on each
truncated year range, attaching the list of refits to \code{fit$retro}.
}
\details{
Run a retrospective (peel) analysis

Peel years are \code{(max_year - folds) : max_year}.
Each refit is attempted with \code{try()} so individual failures do not stop the sequence.
Refits are generated via \code{update(fit, years = ...)}; ensure your \code{fit} object
supports \code{update()} with a \code{years} argument. This function uses
\code{\link[furrr:future_map]{furrr::future_map()}} to run the retros in parallel. Remember to plan your session (e.g.,
\code{future::plan(multisession, workers = 4)}).
}
\examples{
\dontrun{
# Choose your parallel plan (set once per session)
future::plan(future::multisession, workers = 4)

fit <- fit_tam(
  northern_cod_data,
  years = 1983:2024,
  ages = 2:14,
  N_settings = list(process = "iid", init_N0 = FALSE),
  F_settings = list(process = "approx_rw", mu_form = NULL),
  M_settings = list(process = "off", assumption = ~M_assumption),
  obs_settings = list(q_form = ~ q_block, sd_form = ~ sd_obs_block)
)
retros <- fit_retro(fit, folds = 5, progress = TRUE)
head(retros$pop$ssb)
}

}
\seealso{
\code{\link[=fit_tam]{fit_tam()}}, \code{\link[=sim_tam]{sim_tam()}}
}
