% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/model.R
\name{dprocess_2d}
\alias{dprocess_2d}
\alias{rprocess_2d}
\title{Two–dimensional process error: density and simulation}
\usage{
dprocess_2d(x, phi = NA, sd = 1, type = c("iid", "rw", "ar1"))

rprocess_2d(ny, na, phi = NA, sd = 1, type = c("iid", "rw", "ar1"))
}
\arguments{
\item{x}{A numeric matrix (\eqn{n_y \times n_a}) of process residuals
for \code{dprocess_2d()}.}

\item{phi}{Length-2 numeric vector \code{c(phi_age, phi_year)} with
values in \code{(-1, 1)} for AR1; ignored for IID and RW.}

\item{sd}{Positive scalar \eqn{\sigma}. For IID it is the marginal SD.
For RW it scales the difference penalties. For AR1 it targets the
marginal SD after internal variance rescaling.}

\item{type}{One of \code{"iid"}, \code{"rw"}, or \code{"ar1"}.}

\item{ny, na}{Positive integers: numbers of years and ages for
\code{rprocess_2d()}.}
}
\value{
\itemize{
\item \code{dprocess_2d()}: a single numeric log-density value.
\item \code{rprocess_2d()}: a numeric matrix of dimension \code{ny × na}.
}
}
\description{
Helpers for working with simple age × year process-error fields:
independent and identically distributed (IID), separable 2D random walk
(RW), and separable 2D AR(1) (AR1).
\itemize{
\item \code{dprocess_2d()} returns the log-density contribution for a
given matrix \code{x}.
\item \code{rprocess_2d()} generates a matrix draw with the requested
dependence structure.
}
}
\details{
2D Gaussian Process Densities and Simulators (age × year)

Let \eqn{X \in \mathbb{R}^{n_y \times n_a}} denote the process on
year (\eqn{y}) and age (\eqn{a}) indices. The three options are:

\strong{IID}: entries are independent \eqn{N(0, \sigma^2)}.

\strong{RW}: a separable first–difference penalty in both dimensions.
The density is proportional to
\deqn{\sum_{a} \sum_{y=2}^{n_y} (X_{y,a}-X_{y-1,a})^2 +
      \sum_{y} \sum_{a=2}^{n_a} (X_{y,a}-X_{y,a-1})^2,}
implemented via \code{RTMB::dseparable()} using \code{dnorm(diff(.))}
in each margin. This behaves like a 2D intrinsic Gaussian Markov random
field; a global level is not identified.

\strong{AR1}: a stationary separable AR(1) in both dimensions with
correlations \eqn{\phi_\text{age}} (columns) and \eqn{\phi_\text{year}} (rows),
satisfying \eqn{|\phi|<1}. The implied covariance is
\deqn{\mathrm{Cov}\{\mathrm{vec}(X)\} =
      \frac{\sigma^2}{(1-\phi_\text{age}^2)(1-\phi_\text{year}^2)}
      \; \Sigma_\text{age} \otimes \Sigma_\text{year},}
where \eqn{\Sigma_\cdot} are AR(1) correlation matrices with entries
\eqn{\phi^{|i-j|}}. We pass the variance scaling to \code{dseparable()} so that
the marginal variance of \eqn{X} is approximately \eqn{\sigma^2}.

\emph{Identifiability:} For \code{type = "rw"}, the field is non-stationary
(no anchored mean). If you also include fixed-effects for a mean surface,
ensure these do not reintroduce confounding with the RW null space.
}
\section{Numerical notes}{

For AR1 with \code{phi} very close to \code{±1}, the variance factor
\eqn{1 / [(1-\phi_\text{age}^2)(1-\phi_\text{year}^2)]} can explode and
lead to ill-conditioned covariances. Consider bounding \code{phi} away
from \code{±1} during estimation.
}

\examples{
# Simulate three fields with the same sd
set.seed(1)
X_iid <- rprocess_2d(ny = 10, na = 8, sd = 0.3, type = "iid")
X_rw  <- rprocess_2d(ny = 10, na = 8, sd = 0.3, type = "rw")
X_ar1 <- rprocess_2d(ny = 10, na = 8, sd = 0.3, type = "ar1", phi = c(0.8, 0.9))

# Log-density of a realized field under each model
dprocess_2d(X_iid, sd = 0.3, type = "iid")
dprocess_2d(X_rw,  sd = 0.3, type = "rw")
dprocess_2d(X_ar1, sd = 0.3, type = "ar1", phi = c(0.8, 0.9))

}
\seealso{
\code{\link[RTMB]{dseparable}}, \code{\link[RTMB]{dautoreg}},
\code{\link[MASS]{mvrnorm}}
}
