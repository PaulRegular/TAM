% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prep.R
\name{make_dat}
\alias{make_dat}
\title{Build a self-contained data list for TAM}
\usage{
make_dat(
  obs,
  years = NULL,
  ages = NULL,
  N_settings = list(process = "iid", init_N0 = FALSE),
  F_settings = list(process = "rw", mu_form = NULL),
  M_settings = list(process = "off", mu_form = NULL, assumption = ~I(0.2), age_breaks =
    NULL),
  obs_settings = list(sd_form = ~sd_obs_block, q_form = ~q_block)
)
}
\arguments{
\item{obs}{A list of tidy observation data.frames: \code{catch}, \code{index},
\code{weight}, and \code{maturity}. See \strong{Details}.}

\item{years}{Integer vector of model years (strictly increasing).
Inferred from \code{obs} data.frames if \code{NULL}.}

\item{ages}{Integer vector of model ages (strictly increasing).
Inferred from \code{obs} data.frames if \code{NULL}.}

\item{N_settings}{A list with elements:
\describe{
\item{process}{One of \code{"off"}, \code{"iid"}, \code{"rw"}, or \code{"ar1"}.}
\item{init_N0}{Logical; if \code{TRUE}, estimate an initial level for the
first-year abundance. If \code{process == "off"} and \code{init_N0 == FALSE},
this is forced to \code{TRUE}.}
}}

\item{F_settings}{A list with elements:
\describe{
\item{process}{One of \code{"iid"}, \code{"rw"}, or \code{"ar1"}. For \code{"rw"}, TAM treats
the process as non-stationary (no mean structure).}
\item{mu_form}{An optional formula for mean-\eqn{F}; ignored (with
warning) when \code{process == "rw"}. Typical usage is a block factor
(e.g., \code{~ F_a_block + F_y_block}) or \code{~ 1} for an intercept.}
}}

\item{M_settings}{A list with elements:
\describe{
\item{process}{One of \code{"off"}, \code{"iid"}, or \code{"ar1"}.}
\item{mu_form}{Optional formula for mean-\eqn{M} (on the log scale) built
on \code{obs$weight}. If provided together with \code{assumption}, the intercept
in \code{mu_form} is dropped (warning) so assumed levels act as fixed
offsets.}
\item{assumption}{Optional one-sided formula giving fixed (non-estimated)
log-\eqn{M} offsets, e.g. \code{~ I(0.2)} or a column reference such as
\code{~ log(m_assumption)}.}
\item{age_breaks}{Optional integer break points used by \code{\link[=cut_ages]{cut_ages()}} to
define \code{age_blocks} for coupling \eqn{M} deviations across ages.}
}}

\item{obs_settings}{A list with elements:
\describe{
\item{sd_form}{Formula for observation SD blocks, evaluated on the
combined obs map (e.g., \code{~ sd_obs_block}).}
\item{q_form}{Formula for catchability blocks, evaluated on the index
table (e.g., \code{~ q_block}).}
}}
}
\value{
A named list \code{dat} containing:
\itemize{
\item \code{years}, \code{ages}, \code{obs} (per-type tables merged to full grid),
\item \code{SW}, \code{MO} weight-at-age and maturity matrices (\verb{year × age}),
\item \code{obs_map}, \code{log_obs},
\item design matrices: \code{sd_obs_modmat}, \code{q_modmat}, and optionally
\code{F_modmat}, \code{M_modmat},
\item mean-level placeholders: \code{log_mu_f} and/or \code{log_mu_m} (or \code{log_mu_assumed_m}),
\item process settings: \code{N_settings}, \code{F_settings}, \code{M_settings},
\item AR(1) parameter placeholders \verb{logit_phi_*} set only for \code{"ar1"} processes.
}
}
\description{
\code{make_dat()} converts tidy observation inputs and modeling options into the
structured list \code{dat} expected by TAM’s likelihood/simulation functions. It
expands an age–year grid, merges observations, constructs design matrices for
observation SDs, catchability, and mean-\eqn{F} / mean-\eqn{M} (when used),
and derives helper mappings and settings.
}
\details{
\strong{Observation handling}
\itemize{
\item Inputs are expected as a list with components \code{catch}, \code{index}, \code{weight},
and \code{maturity} (each with at least columns \code{year}, \code{age}, and a value
column named \code{obs} for \code{catch}/\code{index}, or \code{weight}/\code{mat} renamed to
\code{obs}).
\item Observations are merged to the full \code{expand.grid(year, age)}.
\item A combined observation table is created for catch and index; \code{log(0)} is
treated as \code{NA} (to be handled via random effects).
}

\strong{Design matrices}
\itemize{
\item \code{obs_settings$sd_form} is evaluated on the combined obs map to produce
\code{sd_obs_modmat}.
\item \code{obs_settings$q_form} is evaluated on the index table to produce
\code{q_modmat}.
\item If \code{F_settings$mu_form} is provided and \code{F_settings$process != "rw"},
\code{F_modmat <- model.matrix(mu_form, data = obs$catch)}; otherwise an overall
mean is implied (\code{log_mu_f <- 0}, \code{F_modmat <- 0}).
\item If \code{M_settings$mu_form} is provided, \code{M_modmat <- model.matrix(mu_form, data = obs$weight)}. If an \code{assumption} is also supplied (i.e., fixed
offsets), the intercept in \code{mu_form} is dropped and a warning is issued.
\item If neither \code{M_settings$mu_form} nor \code{M_settings$assumption} is supplied,
the function stops, because \eqn{M} must be identified by either a fixed
assumption or a mean structure.
}

\strong{Process options & guards}
\itemize{
\item If \code{N_settings$process == "off"} and \code{init_N0 == FALSE}, \code{init_N0} is
forced to \code{TRUE} (with a warning) so the first-year abundance is
estimable.
\item If \code{F_settings$process == "rw"} and \code{mu_form} is given, \code{mu_form} is
ignored (with a warning) because TAM treats the RW as non-stationary
without drift.
\item \code{M_settings$age_breaks} (vector of break points on ages \eqn{\ge} min
modeled age + 1) defines \code{M_settings$age_blocks} via \code{\link[=cut_ages]{cut_ages()}}, used
to couple \eqn{M} deviations across age.
\item The AR(1) correlation parameters are only “turned on” (initialized) for
processes whose \code{process == "ar1"}; otherwise they are set to \code{NA} in
\code{dat} and ignored by the model.
}
}
\examples{
dat <- make_dat(
  northern_cod_data,
  years = 1983:2024,
  ages  = 2:14,
  N_settings = list(process = "iid", init_N0 = FALSE),
  F_settings = list(process = "rw", mu_form = NULL),
  M_settings = list(process = "off", assumption = ~ I(0.3)),
  obs_settings = list(sd_form = ~ sd_obs_block, q_form = ~ q_block)
)
str(dat)

}
\seealso{
\code{\link[stats:model.matrix]{stats::model.matrix()}}, \code{\link[=cut_ages]{cut_ages()}}
}
